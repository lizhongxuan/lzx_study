# 性能优化案例 - 存储

> **导航**：[🔙 返回目录页](./README.md)
---
### 案例一：去重分片架构优化 (No-Reroute Strategy)

####   科普的简介

> 针对分布式存储集群频繁发生的**雪崩效应**，我设计了一套**“去 Reroute + 写入积压”**的机制。优化的原理是**故障隔离**，防止单点故障因流量转发（Reroute）导致其他节点负载过高而级联崩溃。最终达到的效果是集群从半年 5 次故障降为 0 次，彻底根治了雪崩。

#### 背景

集群曾频繁发生雪崩，半年内发生了 5 次不可用故障 。旧机制下，当某个存储节点故障时，写入流量会自动转发（Reroute）给剩余健康节点 。这导致剩余节点负载激增（需创建新索引），处理变慢，进而也被拖垮，造成全链路不可用 。

#### 实现逻辑

1.**移除重分片 (Remove Reroute)**：无论节点是否存活，写入分片规则绝对固定，**不转发流量**，避免新索引创建带来的压力 。


2.**写入侧积压 (Backpressure)**：当节点挂掉时，采集端（vminsert）将数据**积压在本地磁盘队列**（Disk Queue）中，等待节点恢复后回放 。


3.**双副本查询**：为了防止积压期间数据不可查，采用**双副本写入**。Meta-service 感知到节点 A 挂了，会自动指挥查询端读取健康的副本节点 B 。



#### 难点

1.**可用性保障**：在不允许重分片的情况下，如何保证用户还能查到数据？答案是依靠**双副本**和智能的 **Meta-service** 路由切换 。


2.**无感切换**：需要自研 Meta-service 适配多种服务发现协议，实时感知节点状态并下发给查询端 。



#### 结果

1.**稳定性极大提升**：集群不可用级别的故障从半年 5 次降为 **0 次** 。


2.**故障自愈**：实现了对单实例、多实例故障的完全容忍，局部故障对用户无感 。



#### 思考

1.**设计哲学**：在分布式系统中，“快速失败”或者“局部降级（积压）”往往比“强行重试（转发）”更安全。保护剩余的健康节点比挽救故障节点更重要 。
