# 性能优化案例 - 云原生

> **导航**：[🔙 返回目录页](./README.md)
---
### 案例一：采集资源调优 (Resource Optimization)

#### 跟面试官科普的简介

> 面试官，在 K8s 大规模环境下，我针对采集组件（Agent）做了资源调优。主要是针对**启动时的惊群效应**和**运行时的 GC 压力**进行了优化（优化原理）。最终达到的效果是消除了资源毛刺，并且节省了数万核的 CPU 成本。

#### 背景

随着 K8s 集群规模扩大，Pod 重启或扩容时，大量采集目标（Target）同时建立连接，导致 CPU/内存瞬间飙升（Spikes）甚至 OOM 。同时，频繁的对象创建销毁导致 Go 语言的 GC 压力大，CPU 利用率虚高 。

#### 实现逻辑

1.**分批启动 (Staggered Start)**：引入队列和延迟机制，将采集任务的启动时间打散，避免瞬间流量冲击 。


2.**对象池 (Object Pooling)**：在删除大量采集对象或采集过程中，复用内存对象，限制并发数，防止内存飙升 。


3.**GOMEMLIMIT 调优**：显式设置 Go 运行时的内存限制，提高 GC 触发的阈值（以空间换时间），大幅降低 GC 频率 。



#### 难点
1.**无感扩缩容**：配合动态分片算法，在优化资源的同时，还需要确保采集任务在实例间平滑迁移，不丢失数据 。

#### 结果

1.**成本节约**：整体节约了**数万核 CPU** 。


2.**曲线平滑**：删改大量采集对象时，内存曲线平滑，不再出现 OOM 。

#### 思考

1.**语言特性深度**：做基础设施的性能优化，必须深入理解语言运行时（如 Go Runtime GC）的特性，简单的代码逻辑优化往往不如参数调优带来的收益大 。
